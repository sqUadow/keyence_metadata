<!DOCTYPE html>
<html>
<head>
    <title>TIFF Metadata Viewer</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        .metadata-table {
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }
        .metadata-table td, .metadata-table th {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .metadata-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .error { background-color: #ffebee; color: #c62828; }
        .info { background-color: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TIFF Metadata Viewer</h1>
        <p>Upload a TIFF file to view its metadata</p>
        <input type="file" id="fileInput" accept=".tiff,.tif">
        <div id="status"></div>
        <div id="output"></div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'error' : 'info';
        }

        async function loadPyodide() {
            try {
                showStatus('Loading Pyodide...');
                let pyodide = await loadPyodide();
                showStatus('Pyodide loaded successfully');
                
                // Define the Python functions
                await pyodide.runPythonAsync(`
                    import re
                    import js

                    def parse_metadata(content):
                        try:
                            # Find the <Data> ... </Data> block
                            match = re.search(r'<Data>(.*?)</Data>', content, re.DOTALL)
                            if not match:
                                js.console.log("No <Data> block found")
                                return {}

                            data_str = match.group(1)
                            metadata = {}

                            # --- Image Section ---
                            image_match = re.search(r'<Image [^>]*>(.*?)</Image>', data_str, re.DOTALL)
                            if image_match:
                                image_data = image_match.group(1)
                                metadata['Comment'] = _extract_value(image_data, 'Comment')
                                metadata['OriginalImageSize_Width'] = _extract_value(image_data, 'OriginalImageSize', 'Width')
                                metadata['OriginalImageSize_Height'] = _extract_value(image_data, 'OriginalImageSize', 'Height')
                                metadata['DigitalZoom'] = _extract_value(image_data, 'DigitalZoom')
                                metadata['Calibration'] = _extract_value(image_data, 'Calibration')

                            # --- Lens Section ---
                            lens_match = re.search(r'<Lens [^>]*>(.*?)</Lens>', data_str, re.DOTALL)
                            if lens_match:
                                lens_data = lens_match.group(1)
                                metadata['LensName'] = _extract_value(lens_data, 'LensName')
                                metadata['Magnification'] = _extract_value(lens_data, 'Magnification')
                                metadata['NumericalAperture'] = _extract_value(lens_data, 'NumericalAperture')
                                metadata['WorkingDistance'] = _extract_value(lens_data, 'WorkingDistance')

                            return metadata
                        except Exception as e:
                            js.console.log(f"Error in parse_metadata: {str(e)}")
                            return {}

                    def _extract_value(data_str, tag, subtag=None, search_in=None):
                        try:
                            if search_in:
                                outer_match = re.search(rf'<{search_in} [^>]*>(.*?)</{search_in}>', data_str, re.DOTALL)
                                if not outer_match:
                                    return None
                                data_str = outer_match.group(1)

                            if subtag:
                                pattern = rf'<{tag} [^>]*>.*?<{subtag} [^>]*>(.*?)</{subtag}>.*?</{tag}>'
                            else:
                                pattern = rf'<{tag} [^>]*>(.*?)</{tag}>'

                            match = re.search(pattern, data_str, re.DOTALL)
                            return match.group(1) if match else None
                        except Exception as e:
                            js.console.log(f"Error in _extract_value: {str(e)}")
                            return None

                    def format_metadata_table(metadata):
                        if not metadata:
                            return "<p>No metadata found in file.</p>"
                        
                        html = "<table class='metadata-table'>"
                        html += "<tr><th>Parameter</th><th>Value</th></tr>"
                        for key, value in metadata.items():
                            if value is not None:
                                html += f"<tr><td>{key}</td><td>{value}</td></tr>"
                        html += "</table>"
                        return html
                `);
                
                return pyodide;
            } catch (error) {
                showStatus('Error loading Pyodide: ' + error.message, true);
                throw error;
            }
        }

        let pyodideReadyPromise = loadPyodide();

        async function processTiff(file) {
            try {
                showStatus('Processing file...');
                let pyodide = await pyodideReadyPromise;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const content = e.target.result;
                        console.log('File content length:', content.length);
                        
                        // Run the Python code on the file content
                        const result = await pyodide.runPythonAsync(`
                            try:
                                content = """${content}"""
                                metadata = parse_metadata(content)
                                format_metadata_table(metadata)
                            except Exception as e:
                                import sys
                                import traceback
                                traceback.print_exc(file=sys.stdout)
                                "Error processing file: " + str(e)
                        `);
                        
                        document.getElementById('output').innerHTML = result;
                        showStatus('File processed successfully');
                    } catch (error) {
                        showStatus('Error processing file content: ' + error.message, true);
                        console.error('Processing error:', error);
                    }
                };
                
                reader.onerror = function() {
                    showStatus('Error reading file', true);
                };
                
                // Read the file as text
                reader.readAsText(file, 'utf-8');
            } catch (error) {
                showStatus('Error processing file: ' + error.message, true);
                console.error('Processing error:', error);
            }
        }

        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                processTiff(file);
            }
        });
    </script>
</body>
</html>